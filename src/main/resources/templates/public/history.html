<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultrag.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUXURY BUS</title>

    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="76x76" href="../../favicon/logo72x72.png">
    <link rel="icon" type="image/icon" sizes="32x32" href="../../favicon/logo32x32.png">
    <link rel="icon" type="image/icon" sizes="16x16" href="../../favicon/logo16x16.png">
    <link rel="manifest" href="../../favicon/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">

    <!-- Styles -->
    <link th:href="@{/css/main.css}" rel="stylesheet" type="text/css" href="../../css/main.css">

    <!-- Script -->
    <script th:src="@{/js/scripts.js}"></script>

</head>

<body>
<!-- Header -->
<div th:replace="~{clients/header}"></div>

<a href="#home" class="back-to-top">
    <img src="../../icon/to-top.svg" alt="">
</a>

<!-- Main -->
<main class="profile">
    <div class="container">
        <!-- Profile content -->
        <div class="profile-container">
            <div class="row gy-md-3">
                <div class="col-3 col-xl-4 d-lg-none">
                    <aside class="profile__sidebar">
                        <!-- Menu 1 -->
                        <a th:href="@{/user/info}" class="profile-menu">
                            <img src="../../icon/Profile.svg" alt="" class="profile-menu__icon">
                            <span class="profile-menu__title">Thông tin tài khoản</span>
                        </a>

                        <!-- Menu 2 -->
                        <a th:href="@{/user/history}" class="profile-menu">
                            <img src="../../icon/History.svg" alt="" class="profile-menu__icon">
                            <span class="profile-menu__title">Lịch sử mua vé</span>
                        </a>

                        <!-- Menu 3 -->
                        <a class="profile-menu">
                            <img src="../../icon/Address.svg" alt="" class="profile-menu__icon">
                            <span class="profile-menu__title">Địa chỉ của bạn</span>
                        </a>

                        <!-- Menu 4 -->
                        <a class="profile-menu">
                            <img src="../../icon/Profile.svg" alt="" class="profile-menu__icon">
                            <span class="profile-menu__title">Đặt lại mật khẩu</span>
                        </a>
                        <!-- Menu 5 -->
                        <a th:href="@{/logout}" class="profile-menu">
                            <img src="../../icon/Logout.svg" alt="" class="profile-menu__icon">
                            <span class="profile-menu__title">Đăng xuất</span>
                        </a>
                    </aside>
                </div>
                <div class="col-9 col-xl-8 col-lg-12">
                    <div class="profile-sidebar">
                        <div class="row gy-3">
                            <div class="col-12">
                                <!-- Title -->
                                <div class="profile-sidebar__top">
                                    <div class="profile-sidebar__top-left">
                                        <h2 class="profile-sidebar__heading">
                                            <a href="/">
                                                <img src="../../icon/arrow-left.svg" alt="" class="icon profile-sidebar__icon">
                                            </a>
                                            Lịch sử mua vé
                                        </h2>
                                        <p class="profile-sidebar__desc">Theo dõi và quản lý quá trình lịch sử mua vé của bạn</p>
                                    </div>
                                    <a th:href="@{/user}" class="profile-sidebar__top-right">
                                        <button class="btn btn--primary btn--rounded">Đặt vé</button>
                                    </a>
                                </div>

                                <!-- Table
                                <div class="row">
                                    <div class="col-3">
                                        <div class="profile-sidebar__bottom-qr">
                                            <img src="./assets/imgs/avatar.png" alt="" class="profile-sidebar__bottom-img">
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="profile-sidebar__bottom-infor">
                                            <div class="profile-sidebar__text">
                                                <span class="profile-sidebar__text-title">Chuyến xe:</span>
                                                <span class="profile-sidebar__text-title">hà Tĩnh - Đã Nẵng</span>
                                            </div>
                                            <div class="profile-sidebar__text">
                                                <span class="profile-sidebar__text-title">Số điện thoại:</span>
                                                <span class="profile-sidebar__text-title">0192828929</span>
                                            </div>
                                            <div class="profile-sidebar__text">
                                                <span class="profile-sidebar__text-title">Thời gian:</span>
                                                <span class="profile-sidebar__text-title">20:00 27/03/2025</span>
                                            </div>
                                            <div class="profile-sidebar__text">
                                                <span class="profile-sidebar__text-title">Điểm đón:</span>
                                                <span class="profile-sidebar__text-title">Hà Tĩnh</span>
                                            </div>
                                            <div class="profile-sidebar__text">
                                                <span class="profile-sidebar__text-title">Điểm trả:</span>
                                                <span class="profile-sidebar__text-title">Đã Nẵng</span>
                                            </div>
                                            <div class="profile-sidebar__text">
                                                <span class="profile-sidebar__text-title">Số ghế:</span>
                                                <span class="profile-sidebar__text-title">A03</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-3">
                                        <div class="profile-sidebar__bottom-act">
                                            <div class="flex">
                                                <div class="dots"></div>
                                                Chưa xuất phát
                                            </div>
                                            <button class="btn btn--primary btn--rounded">Đánh giá</button>
                                        </div>
                                    </div>
                                </div> -->

                                <!-- Table -->
                                <div class="table-antd">
                                    <div class="table-container">
                                        <div class="ant-table">
                                            <div class="ant-table__container" style="overflow-x: scroll; max-height: 400px;">
                                                <div class="ant-table__header">
                                                    <table class="ant-table__table" style="table-layout: fixed;">
                                                        <colgroup>
                                                            <col style="width: 100px;"/>
                                                            <col style="width: 180px;"/>
                                                            <col style="width: 100px;"/>
                                                            <col style="width: 100px;"/>
                                                            <col style="width: 100px;"/>
                                                            <col style="width: 100px;"/>
                                                            <col style="width: 120px;"/>
                                                            <col style="width: 100px;"/>
                                                            <col style="width: 150px;"/>
                                                        </colgroup>
                                                        <thead class="ant-table-thead">
                                                        <tr>
                                                            <th class="ant-table-cell text-center">Mã QR vé</th>
                                                            <th class="ant-table-cell text-center">Chuyến xe</th>
                                                            <th class="ant-table-cell text-center">Thời gian</th>
                                                            <th class="ant-table-cell text-center">Điểm đón</th>
                                                            <th class="ant-table-cell text-center">Điểm trả</th>
                                                            <th class="ant-table-cell text-center">Số ghế</th>
                                                            <th class="ant-table-cell text-center">Số điện thoại</th>
                                                            <th class="ant-table-cell text-center">Trạng thái</th>
                                                            <th class="ant-table-cell text-center">Thao tác</th>
                                                            <th class="ant-table-cell ant-table-cell-scrollbar"></th>
                                                        </tr>
                                                        </thead>
                                                    </table>
                                                </div>
                                                <div class="ant-table__body" th:if="${bookings != null}">
                                                    <div th:if="${my_error}" class="alert alert-success col-6 w-100">
                                                        <span th:text="${my_error}"> </span>
                                                    </div>
                                                    <table class="ant-table__table" style="table-layout: fixed;">
                                                        <colgroup>
                                                            <col style="width: 100px;" />
                                                            <col style="width: 180px;" />
                                                            <col style="width: 100px;" />
                                                            <col style="width: 100px;" />
                                                            <col style="width: 100px;" />
                                                            <col style="width: 100px;" />
                                                            <col style="width: 120px;" />
                                                            <col style="width: 100px;" />
                                                            <col style="width: 150px;" />
                                                        </colgroup>
                                                        <tbody class="ant-table-tbody">
                                                        <!-- History 1 -->
                                                        <tr class="ant-table-measure-row" th:each="booking : ${bookings}">
                                                            <td class="text-center ant-table-cell">
                                                                <img id="qrcode" class="qrcode" th:data-booking-id="${booking.getId()}" alt="QR CODE">
                                                            </td>
                                                            <td class="text-center border" >
                                                                <p class="font-medium" th:text="${booking.getTrip().getName()}"></p>
                                                            </td>
                                                            <td class="text-center border" >
                                                                <p class="font-medium" th:text="${booking.getTrip().getStartDate()}"></p>
                                                            </td>
                                                            <td class="text-center border" >
                                                                <p class="font-medium" th:text="${booking.getDeparture().stopName}"></p>
                                                            </td>
                                                            <td class="text-center border" >
                                                                <p class="font-medium" th:text="${booking.getArrival().stopName}"></p>
                                                            </td>
                                                            <td class="text-center border" >
                                                                <p class="font-medium" th:each="ticket : ${booking.getTickets()}">
                                                                    <span th:text="${ticket.getSeatName() != null ? ticket.getSeatName() : '&nbsp;'}"></span>
                                                                </p>
                                                            </td>
                                                            <td class="text-center border" >
                                                                <p class="font-medium" th:text="${booking.getPhoneNumber()}"></p>
                                                            </td>
                                                            <td class="text-center border" >
                                                                <p class="font-medium" th:text="${booking.getTrip().status.getDisplayName()}"></p>
                                                            </td>
                                                            <td class="text-center ant-table-cell">
                                                                <button class="btn btn--primary btn-rounded"
                                                                        data-bs-toggle="modal" data-bs-target="#ratingModal"
                                                                        th:attr="
                                                                            data-booking-id=${booking.getId()},
                                                                            data-trip-name=${booking.getTrip().getName()},
                                                                            data-trip-time=${booking.getTrip().getStartDate()}"
                                                                        th:classappend="${booking.isRated() || booking.getTrip().status.getStatus() eq  'BOOKED' ? 'disabled ' : ''}"
                                                                        th:text="${booking.isRated() ? 'Đã đánh giá' : 'Đánh giá'}"
                                                                >
                                                                </button>
                                                            </td>
                                                        <tr class="ant-table-placeholder">
                                                            <td colspan="8" class="ant-table-cell">

                                                            </td>
                                                        </tr>
                                                        </tbody>
                                                    </table>

                                                    <!-- Modal add one time modal -->
                                                    <form action="#" th:action="@{/user/rating}" method="post">
                                                        <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                            <div class="modal-dialog">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h1 class="modal-title fs-5" id="exampleModalLabel">Đánh Giá chuyến đi</h1>
                                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <input hidden="hidden" id="bookingId" name="bookingId" >
                                                                        <p class="card-text m-0" id="tripName" > <strong > </strong></p>
                                                                        <p class="card-text m-0" id="time"  > <strong ></strong></p>
                                                                        <div class="location mt-4">
                                                                            <textarea class="form-control" id="exampleFormControlTextarea1" rows="3" name="describe" placeholder="Chi tiết đánh giá"></textarea>
                                                                        </div>
                                                                        <div class="rate bg-success py-3 text-white mt-3">
                                                                            <h6 class="mb-0 text-center">Chất lượng sản phẩm</h6>
                                                                            <div class="rating">
                                                                                <input type="radio" name="rating" value="5" id="5"><label for="5">☆</label>
                                                                                <input type="radio" name="rating" value="4" id="4"><label for="4">☆</label>
                                                                                <input type="radio" name="rating" value="3" id="3"><label for="3">☆</label>
                                                                                <input type="radio" name="rating" value="2" id="2"><label for="2">☆</label>
                                                                                <input type="radio" name="rating" value="1" id="1"><label for="1">☆</label>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Trở lại</button>
                                                                        <button type="submit" class="btn btn-success">Hoàn thành</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<div th:replace="~{clients/footer}"></div>

<script>
    // Back to top
    let backToTopBtn = document.querySelector('.back-to-top')

    window.onscroll = () => {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            backToTopBtn.style.display = 'flex';
        } else {
            backToTopBtn.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const qrCodeElements = document.querySelectorAll('.qrcode');

        qrCodeElements.forEach(function(imgElement) {
            const bookingId = imgElement.getAttribute('data-booking-id');

            imgElement.src = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" + bookingId;
        });




        var modal = document.getElementById('ratingModal');

        modal.addEventListener('shown.bs.modal', function(event) {
            var button = event.relatedTarget;
            var bookingIdText = button.getAttribute('data-booking-id');
            var tripNameText = button.getAttribute('data-trip-name');
            var timeText = button.getAttribute('data-trip-time');

            var tripName = document.getElementById('tripName');
            var bookingId = document.getElementById('bookingId');
            var time = document.getElementById('time');


            tripName.innerText = "Chuyến xe : " + tripNameText;
            time.innerText = "Thời gian : " + timeText;
            bookingId.value = bookingIdText;
        });
    });

</script>
</body>

</html>